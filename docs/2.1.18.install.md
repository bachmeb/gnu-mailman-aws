# 2.1.18.install

This project describes the process of installing GNU Mailman 2.18 on an Amazon AWS EC2 instance. Currently the default package available in Amazon Linux is version 2.1.15. Version 2.1.18 of GNU Mailman includes a fix to allow mail to be delivered to subscribers whose email service bounces messages not conforming to the DMARC standard. 

###References
* http://tombuntu.com/index.php/2009/12/22/send-outgoing-email-with-postfix/
* http://www.uponmyshoulder.com/blog/2010/set-up-a-mail-server-on-amazon-ec2/
* http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html
* https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/3/html/Reference_Guide/s1-bind-zone.html
* http://www.mail-tester.com/spf/godaddy
* http://www.openspf.org/FAQ/Common_mistakes
* http://www.tldp.org/LDP/nag2/x-087-2-mail.routing.html
* https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html
* http://cybart.com/how-to-install-and-configure-postfix-on-amazon-ec2/
* http://www.gnu.org/software/mailman/mailman-install/
* http://www.yolinux.com/TUTORIALS/LinuxTutorialMailman.html
* http://minhtech.com/featuredlinux/install-and-configure-mailman/
* http://docs.aws.amazon.com/ses/latest/DeveloperGuide/smtp-issues.html
* http://www.postfix.org/BASIC_CONFIGURATION_README.html
* http://www.postfix.org/VIRTUAL_README.html
* http://www.postfix.org/postconf.1.html
* http://www.scriptinstallation.in/smtpd_banner.html
* http://exchangepedia.com/2006/12/should-mx-record-point-to-cname-records-aliases.html
* http://www.wizcrafts.net/iptables-blocklists.html
* http://www.gnu.org/software/mailman/mailman-install/node9.html
* http://wiki.list.org/DOC/After%20installing%20the%20cronjob%20you%20receive%20a%20-bin-sh-%20mailman-%20command%20not%20found%20error
* http://ss64.com/bash/crontab.html
* http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-hostname.html
* http://unix.stackexchange.com/questions/58243/which-name-should-be-used-for-myhostname-in-postfixs-main-cf

##### Create a new vm
* https://aws.amazon.com/ec2/

##### Step 1: Choose an Amazon Machine Image (AMI)
	Amazon Linux AMI 2015.09.1 (HVM), SSD Volume Type - ami-f0091d91

##### Step 2: Choose an Instance Type
	Family: General purpose
	Type: t2.micro
	vCPUs: 1
	Memory: 1
	Instance Storage: EBS only
	EBS-Optimized: -
	Network Performance: Low to Moderate

##### Step 3: Configure Instance Details
	Number of instances: 	1
	Network: (default)
	Subnet: No preference (default subnet in any Availability Zone)
	EBS-optimized: No
	Monitoring: No
	Termination protection: YES <---- UPDATE THIS
	Shutdown behavior: Stop
	IAM role: None
	Tenancy: default
	Host ID: 
	Affinity: Off
	Kernel ID: Use default
	RAM disk ID: Use default
	User data: 
	Assign Public IP: Use subnet setting (Enable)
	Network interfaces: 
	Purchasing option: On demand

##### Step 4: Add Storage
	Volume Type: Root
	Device: /dev/xvda
	Snapshot: snap-ad8e61f8
	Size (GiB): 8
	Volume Type: General Purpose SSD (GP2)
	IOPS: 24 / 3000
	Delete on Termination: Yes
	Encrypted: Not Encrypted

##### Step 5: Tag Instance
	Key: Name
	Value:

##### Step 6: Configure Security Group 
*Allow ICMP, SSH, and TCP traffic from your IP address*
```
Type       Protocol   Port Range   Source
SSH        TCP        22           your ip address/32
All TCP    TCP        0 - 65535    your ip address/32
All ICMP   All        N/A          your ip address/32
```

##### Download the key pair and change the mode to 400
	chmod 400 pemfile.pem

##### Create an Elastic IP address
*This is important. Read up on the Elastic IP concept.*
* http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html

##### Check Spam Haus and What is My IP Address to see if the Elastic IP address has already been added to the block list
* http://www.spamhaus.org/lookup/
* http://whatismyipaddress.com/blacklist-check

##### Assign the Elastic IP address to your running ec2 instance
* http://aws.amazon.com/

##### Create an MX record in the DNS zone file hosted by your DNS provider
[*Most Internet sites want to direct all inbound mail to a highly available mail server that is capable of handling all this traffic and have it distribute the mail locally. To announce this service, the site publishes a so-called MX record for its local domain in its DNS database. MX stands for Mail Exchanger and basically states that the server host is willing to act as a mail forwarder for all mail addresses in the domain.*](http://www.tldp.org/LDP/nag2/x-087-2-mail.routing.html)
```
; A Records
@	600	IN	A	[000.000.000.000] <-- The Elastic IP address
mail	600	IN	A [000.000.000.000] <-- The Elastic IP address

; CNAME Records
ftp	600	IN	CNAME	@
www	600	IN	CNAME	@

; MX Records
@	600	IN	MX	1 [mail.somedomain.whatever]
```

##### Add a SPF record to the DNS zone file.
[*SPF's purpose is to publish a list of outgoing mail servers. Any servers that do not deliver mail to the world, such as web servers or incoming-only mail servers, should not be listed.*](http://www.openspf.org/FAQ/Common_mistakes)
```
; TXT Records
@	600	IN	TXT	"v=spf1 mx ~all"
```
##### Complete the Request to Remove Email Sending Limitations form. Amazon owns reverse DNS for the EC2 instance. 
* https://aws.amazon.com/forms/ec2-email-limit-rdns-request?catalog=true&isauthcode=true

##### Do a nslookup from your local machine to confirm the current status of reverse DNS.
*At this point, it will probably still resolve to ec2-[your elastic ip address].us-west-2.compute.amazonaws.com. My reverse DNS resolved correctly about an hour after I submitted my request to remove email sending limitations.*  
```
nslookup -type=ptr [your elastic ip address]
```
##### Ping the Elastic IP address to confirm that ICMP traffic is allowed from your IP address
	ping [ec2.ipa.ddr.ess]

##### Ping the domain name to see if DNS has been updated to point to the Elastic IP address
	ping [somedomain.whatever]
    
##### Connect via SSH
*Either:*
```
ssh -i pemfile.pem ec2-user@[ec2.ipa.ddr.ess]
```
*Or:*
```
ssh -i pemfile.pem ec2-user@[somedomain.whatever]
```
##### Check the Linux distro version
	cat /proc/version
	
##### Check the time
	date
	
##### List the available time zones
	ls /usr/share/zoneinfo/

##### Update the /etc/sysconfig/clock file with your time zone
	sudo nano /etc/sysconfig/clock
```
ZONE="America/New_York"
UTC=false
```
##### Create a symbolic link between /etc/localtime and your time zone file
	sudo ln -sf /usr/share/zoneinfo/America/New_York /etc/localtime

##### Check the time
	date

*[When you launch an instance, it is assigned a hostname that is a form of the private, internal IP address. A typical Amazon EC2 private DNS name looks something like this: ip-12-34-56-78.us-west-2.compute.internal, where the name consists of the internal domain, the service (in this case, compute), the region, and a form of the private IP address. Part of this hostname is displayed at the shell prompt when you log into your instance (for example, ip-12-34-56-78). Each time you stop and restart your Amazon EC2 instance (unless you are using an Elastic IP address), the public IP address changes, and so does your public DNS name, system hostname, and shell prompt. Instances launched into EC2-Classic also receive a new private IP address, private DNS hostname, and system hostname when they're stopped and restarted; instances launched into a VPC don't.](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-hostname.html)*

*[If you have a public DNS name registered for the IP address of your instance (such as webserver.mydomain.com), you can set the system hostname so your instance identifies itself as a part of that domain. This also changes the shell prompt so that it displays the first portion of this name instead of the hostname supplied by AWS (for example, ip-12-34-56-78).](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-hostname.html)*

##### Edit the sysconfig network file
	sudo nano /etc/sysconfig/network

*Rather than set the hostname of this machine to match a resolvable web address, this tutorial assumes we want the machine to have a unique hostname that is different than any of the hostnames we define in the public DNS record. The mailman webserver will be addressble by a hostname defined in DNS, but the hostname of the AWS machine does not have to match the hostname of the mailman webserver. We should be able to configure mailman to run on a machine with any hostname, and still offer the mailman web page at a specific web address defined in DNS.*

##### Set the HOSTNAME to the fqdn
<!---HOSTNAME=[somehost.somedomain.whatever]-->
	HOSTNAME=[somehost].localdomain

##### Edit the hosts file
	nano /etc/hosts
```
127.0.0.1  [somehost] [somehost].localdomain localhost localhost.localdomain
```

##### Reboot the system to pick up the new hostname and time zone information in all services and applications
	sudo reboot

##### Connect via SSH
*Either:*
```
ssh -i pemfile.pem ec2-user@[ec2.ipa.ddr.ess]
```
*Or:*
```
ssh -i pemfile.pem ec2-user@[somedomain.whatever]
```
##### Check the time
	date

##### Switch to super user
	sudo su
	
##### Check the default options configured for adding a user on this system
	useradd -D
    
##### Create a non-admin user account for yourself
	useradd [your user account name]
    
##### Set your password
	passwd [your user account name]

##### Edit sudoers file
	vim /etc/sudoers
	:$

##### Add your account to sudoers file
	## LET ME SUDO
	[your user account name] ALL=(ALL) ALL

##### Switch to your user account
	su [your user account name]

##### Ask who am I?
	whoami

##### Echo the value of the $HOME environment variable
	echo $HOME
	
##### Go home
	cd ~
	pwd

##### Change the command prompt to show your username at the fqdn
	export PS1='[\u@\H \W]\$'

##### Read your .bashrc file
	cat .bashrc
	
##### Add the PS1 command to your .bashrc file
	echo 'PS1="[\u@\H \W]\$ "'>>~/.bashrc

##### Read your .bashrc file
	cat .bashrc
	
##### Check the hostname of the ec2 instance
	hostname

##### Check the DNS domain name of the ec2 instance
	dnsdomainname

##### Get the IP address of the internal name server
	grep nameserver /etc/resolv.conf

##### Check the routing table
	route

##### Check the internal IP address
	ifconfig

##### Check the external IP address
	wget http://ipinfo.io/ip -qO -

##### Run a speed test (just for fun)
```
wget https://raw.github.com/sivel/speedtest-cli/master/speedtest_cli.py
chmod +x speedtest_cli.py
./speedtest_cli.py
```

##### Install Linux updates
	sudo yum update
	
##### Install the Apache HTTP server
	yum search httpd
	sudo yum install httpd
	yum list installed | grep httpd

##### See where HTTPD was installed
	whereis httpd

##### Find the httpd.conf file
	sudo find / -name httpd.conf

##### Add this line to httpd.conf
	ServerName localhost

##### Start the Apache HTTP server
	sudo service httpd status
	sudo service httpd start

##### See if a service is listening on port 80
	sudo lsof -ni:80
    
##### Install lynx
	sudo install lynx

##### Visit the test page for the Apache HTTP server on localhost 
	lynx localhost

##### Install telnet on the EC2 instance
	sudo yum install telnet

##### Telnet to port 80 on localhost
	telnet localhost 80
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// ^]
// 
// telnet> q
// Connection closed.
```

##### Add a rule to the AWS security group allowing TCP traffic on port 80 from anywhere
```
Type   Protocol   Port Range   Source
SMTP   TCP        80           0.0.0.0/0
```

##### Telnet to port 80 on the EC2 instance from your local machine
	telnet [somedomain.whatever] 80

##### Visit the test page for the Apache HTTP server from a web browser on your local machine
http://[somedomain.whatever]

*[Before you look at Sendmail or PostFix, you should know about a subsystem of Fedora Core and Red Hat Linux that controls which MTA the system uses. It is critical that you understand this MTA control system, since you need to know which MTA is in use before you can troubleshoot related e-mail problems.](http://books.gigatux.nl/mirror/linuxtroubleshooting/9149final/LiB0159.html)*

##### Check the MTA
	alternatives --display mta
```c
// mta - status is auto.
//  link currently points to /usr/sbin/sendmail.sendmail
// /usr/sbin/sendmail.sendmail - priority 90
//  slave mta-mailq: /usr/bin/mailq.sendmail
//  slave mta-newaliases: /usr/bin/newaliases.sendmail
//  slave mta-rmail: /usr/bin/rmail.sendmail
//  slave mta-sendmail: /usr/lib/sendmail.sendmail
//  slave mta-pam: /etc/pam.d/smtp.sendmail
//  slave mta-sendmailman: /usr/share/man/man8/sendmail.sendmail.8.gz
//  slave mta-mailqman: /usr/share/man/man1/mailq.sendmail.1.gz
//  slave mta-newaliasesman: /usr/share/man/man1/newaliases.sendmail.1.gz
//  slave mta-aliasesman: /usr/share/man/man5/aliases.sendmail.5.gz
// Current `best' version is /usr/sbin/sendmail.sendmail.
```
##### Ask where is sendmail?
	whereis sendmail

##### Check the current run level
	runlevel
	
##### Check to see if sendmail is set to run at boot time for the current run level
	chkconfig --list

##### See if a service is listening on port 25
    sudo lsof -ni:25
```c
// COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
// sendmail 2510 root    4u  IPv4   9784      0t0  TCP 127.0.0.1:smtp (LISTEN)
```
    
##### Telnet to localhost on port 25. The connection should be accepted by sendmail.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// 220 ur.localdomain ESMTP Sendmail 8.14.4/8.14.4; Mon, 22 Feb 2016 14:18:34 -0500
//
// telnet> q
// Connection closed.
```
##### Add a rule to the AWS security group allowing SMTP traffic from anywhere
```
Type   Protocol   Port Range   Source
SMTP   TCP        25           0.0.0.0/0
```
##### Try to telnet from your local machine to the Amazon SES SMTP endpoint on port 25.  
*If you cannot connect to the Amazon SES SMTP endpoint using telnet or openssl, then something in your network (for example, a firewall) is blocking outbound connections over the port you're trying to use.*  
```
telnet email-smtp.us-west-2.amazonaws.com 25
```
```c
// Trying 54.69.81.169...
// Connected to email-smtp.us-west-2.amazonaws.com.
// Escape character is '^]'.
// 220 email-smtp.amazonaws.com ESMTP SimpleEmailService-1207562731 kV5Wz2FTan1oE6hWxLS6
```
##### Try to telnet to the EC2 instance on port 25 from your local machine. The connection should be refused.
	telnet [ec2 ip address] 25
```c
// Trying [ec2 ip address]...
// telnet: connect to address [ec2 ip address]: Connection refused
// telnet: Unable to connect to remote host
```
##### Go to Pingability and check to see if the mail server in the MX record is responding correctly.
* https://pingability.com/zoneinfo.jsp  

*Should return:*
```
Mail Server Info
Info Type  Message
Error	   There was a problem while talking with the mail server. Got 'ConnectException: Connection refused'
```
##### Stop sendmail
	sudo service sendmail status
	sudo service sendmail stop
```c
// Shutting down sm-client:                                   [  OK  ]
// Shutting down sendmail:                                    [  OK  ]
```

##### Telnet to localhost on port 25. The connection should be refused.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// telnet: connect to address 127.0.0.1: Connection refused
```

##### Install Postfix
	yum search postfix
	sudo yum install postfix

##### Ask where is postfix?
	whereis postfix

##### Check the MTA
	alternatives --display mta
```c
// mta - status is auto.
//  link currently points to /usr/sbin/sendmail.sendmail
```
##### Switch the MTA from Sendmail to Postfix
	sudo alternatives --set mta /usr/sbin/sendmail.postfix

##### Check the MTA
	alternatives --display mta
```c
// mta - status is manual.
// link currently points to /usr/sbin/sendmail.postfix
```

##### Check to see if sendmail or postfix is set to run at boot time for the current run level
	chkconfig | grep sendmail
	chkconfig | grep postfix

##### Start Postfix
	sudo service postfix status
	sudo service postfix start

##### See if a service is listening on port 25
    sudo lsof -ni:25
```c
// COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
// master  3398 root   12u  IPv4  23182      0t0  TCP 127.0.0.1:smtp (LISTEN)
```
    
##### Telnet to localhost on port 25. The connection should be accepted by postfix.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// 220 [somehost].localdomain ESMTP Postfix
```

##### Telnet to the [somedomain.whatever] on port 25. The connection should be refused.
	telnet [somedomain.whatever] 25
```c
// Trying [ec2 ip address]...
// telnet: connect to address [ec2 ip address]: Connection refused
```

##### Check the system mail log for connection events
	sudo cat /var/log/maillog

<!---
*[If you want to simulate a reboot without actually rebooting your system, just toggle over to another runlevel and then back to your production default runlevel. After doing this, anything set to run in your default runlevel should start up if not already running.](http://books.gigatux.nl/mirror/linuxtroubleshooting/9149final/LiB0159.html)*
```
# runlevel
N 3
# init 4
# init 3
# /etc/init.d/postfix status
master (pid 5904) is running
```
-->

*[By default, Postfix configuration files are in /etc/postfix. The two most important files are main.cf and master.cf; these files must be owned by root. In /etc/postfix/main.cf you will have to set up a minimal number of configuration parameters.](http://www.postfix.org/BASIC_CONFIGURATION_README.html)*

##### Read the Postfix config file
	less /etc/postfix/main.cf

##### Show the contents of the Postfix config file without any comments
	grep -vE "^\s*(#|$)" /etc/postfix/main.cf
    
##### Show the default Postfix configuration values
	postconf -d

##### Show the current Postfix configuration values
	postconf

##### Compare the default setting with the current settings
	postconf > postconf.txt
	postconf -d > postconf-d.txt
	diff postconf.txt postconf-d.txt 

##### Rename the main.cf file
	sudo mv /etc/postfix/main.cf /etc/postfix/main.cf.backup

##### Make a blank main.cf file
	sudo touch /etc/postfix/main.cf

##### Reload postfix
	sudo postfix reload

*Reloading postfix with a blank main.cf file removes any custom settings and allows the MTA to run with the default settings.*

##### Telnet to localhost on port 25. The connection should be accepted by postfix.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// 220 [somehost].localdomain ESMTP Postfix
```

##### Create a test account
    sudo useradd --create-home -s /sbin/nologin test
    sudo passwd test

##### Install mail
    sudo yum install mail

##### Send a message to the test account from root
    mail test
```
Subject: [time of day]
this is a test message
.
```

##### Check to see if the message was delivered
	sudo cat /var/spool/mail/test

*[Postfix configuration parameters resemble shell variables, with two important differences: the first one is that Postfix does not know about quotes like the UNIX shell does. You specify a configuration parameter as "parameter = value" and you use it by putting a "$" character in front of its name like so: other_parameter = $parameter. You can use $parameter before it is given a value (that is the second main difference with UNIX shell variables). The Postfix configuration language uses lazy evaluation, and does not look at a parameter value until it is needed at runtime.](http://www.postfix.org/BASIC_CONFIGURATION_README.html#syntax)*

##### Set the smtpd banner
*[smtpd_banner is the text that follows the 220 status code in the SMTP greeting banner. Some people like to see the mail version advertised. By default, Postfix shows no version. You MUST specify $myhostname at the start of the text. This is required by the SMTP protocol.](http://www.postfix.org/postconf.5.html#smtpd_banner)*
```
postconf -d smtpd_banner
sudo postconf -e "smtpd_banner = \$myhostname ESMTP \$mail_name [HELLO WORLD]"
postconf smtpd_banner
```

##### Read the main.cf file
	cat /etc/postfix/main.cf

##### See which settings in master.cf are overruled by main.cf
	postconf -n
	
##### Telnet to localhost on port 25. The connection should be accepted by postfix.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// 220 [somehost.somedomain.whatever] ESMTP Postfix [HELLO WORLD]
```

##### Set the postfix hostname
	myhostname = mail.spoonerspizza.com

##### Set mydomain
	mydomain = spoonerspizza.com

##### Set myorigin
	myorigin = $mydomain

##### Send a message to an external email address from your account
	whoami
	mail [external]@[email.address]
```
Subject: [time of day]
Test message from [your account name]
.
```

##### Check the external account to see if the message was delivered. 
* gmail.com

##### Set the inet interfaces
	inet_interfaces = all

##### Set the inet protocols
	inet_protocols = ipv4

##### Set mydestination
	mydestination = $myhostname, $mydomain, localhost



##### Telnet to the EC2 IP address on port 25. The connection should be accepted.
	telnet [ec2 ip address] 25
```
// Trying [ec2 ip address]...
// Connected to [ec2 ip address].
// Escape character is '^]'.
// 220 [somehost.somedomain.whatever] ESMTP Postfix [HELLO WORLD]
```

##### Go to Pingability and check to see if the mail server in the MX record is responding correctly.
* https://pingability.com/zoneinfo.jsp

*Should respond with:*
```
Mail Server Info
Info Type	Message
Information	The mail server accepted email for 'abuse@[somedomain].com' email address as it should have (250 2.1.5 Ok).
Information	The mail server correctly rejected email to 'email_validation_service@domaincheckingservice.pingability.com' (554 5.7.1 <email_validation_service@domaincheckingservice.pingability.com>: Relay access denied)
```

##### Send a test message from the external email account to test@[somedomain.whatever]
* gmail.com

##### Install Mutt
    sudo yum install mutt

##### Check to see if the message was delivered. 
    mutt -f /var/spool/mail/[your user account name]

##### Rename the postfix virtual file 
	sudo mv /etc/postfix/virtual /etc/postfix/virtual.backup

##### Make a new postfix virtual file
    sudo nano /etc/postfix/virtual

##### Add these lines
```
aka@[somedomain.whatever] test
```

##### Recreate the Postfix lookup table
    sudo postmap /etc/postfix/virtual

##### Reload the Postfix config file
    postfix reload

##### Send a message from your account to the alias address
	mail aka@[somedomain.whatever]

##### Check to see if the message was delivered
	sudo cat /var/spool/mail/test
	



##### Send a message to the alias
    mail aka
```
Subject: [time of day]
Local message from me to aka@[somedomain.whatever]
.
```

##### Check to see if it was delivered
    mailx -f /var/spool/mail/test

##### Check the mail log and setup any firewall rules, accordingly.
    cat /var/log/maillog < -- Look for repetitive, unsolicited, foreign traffic
    iptables -vnL
    /etc/init.d/iptables stop
    iptables -vnL
    /etc/init.d/iptables start
    /sbin/iptables -I INPUT -s [ --- malicious ip ---] -j DROP
    iptables -vnL
    /etc/init.d/iptables save

    cat /etc/sysconfig/iptables
    /etc/init.d/iptables stop
    iptables -vnL
    /etc/init.d/iptables start
    iptables -vnL

##### Refer to publicly available block lists for additional IP addresses. 
    http://www.wizcrafts.net/iptables-blocklists.html
    
##### Try to telnet to the Elastic IP address on port 25. The connection should be accepted.
    telnet [elastic ip address] 25

##### Try to telnet from the EC2 instance to the domain name on port 25. The connection should be accepted. 
    telnet [somedomain.whatever] 25

<!---
##### Check python version. Should be 2.7+
	python -V
	
##### Download dnspython
cd ~
ls
wget --no-check-certificate https://pypi.python.org/packages/source/d/dnspython/dnspython-1.11.1.zip
ls -la
Unzip dnspython
unzip dnspython-1.11.1.zip
ls

##### Install dnspython
cd dnspython-1.11.1
python setup.py install
-->

##### Check to see if the filesystem is mounted with the nosuid option.
    mount

##### Check the available versions of mailman with yum
```
yum list available | grep mailman
```
*The current version available in yum on AWS is 2.1.15. We want version 2.1.18*
```
mailman.x86_64                        3:2.1.15-21.20.amzn1          amzn-main   
```

##### Install the GNU Compiler
    yum install gcc

##### See where gcc was installed
    whereis gcc

##### Check the gcc version
    gcc --version 
    
##### See if Mailman is installed
    yum list installed | grep mailman
    
##### Download GNU Mailman 2.1.18
    cd /opt
    wget http://ftp.gnu.org/gnu/mailman/mailman-2.1.18.tgz

##### Extract GNU Mailman
    tar xzf mailman-2.1.18.tgz


##### [Create a mailman user](http://www.gnu.org/software/mailman/mailman-install/node4.html)
    groupadd mailman
    useradd mailman -c "GNU Mailman" -g mailman -d /dev/null -s /sbin/nologin

##### Check the user id and group ids of mailman and apache
    cat /etc/group | grep mailman
    cat /etc/group | grep apache
    cat /etc/passwd | grep mailman
    cat /etc/passwd | grep apache

##### Create the Mailman installation directory
    mkdir /usr/share/mailman
    chgrp mailman /usr/share/mailman
    chmod a+rx,g+ws /usr/share/mailman

##### Create the Mailman lib directory
    mkdir /var/lib/mailman
    chgrp mailman /var/lib/mailman
    chmod a+rx,g+ws /var/lib/mailman
    
##### Configure the Mailman installation. 
* Set the installation directory to /usr/share/mailman. 
* IMPORTANT: Set the Var directory to /var/lib/mailman. 
* Set the group id of the mail wrapper to mailman. 
* Set the group id of the web server wrapper to apache. 
```
cd mailman-2.1.18/
./configure --prefix=/usr/share/mailman/ --with-var-prefix=/var/lib/mailman --with-mail-gid=mailman --with-cgi-gid=apache
```
##### Make and install GNU Mailman
    make
    make install

##### Ask where is mailman?
    whereis mailman

##### Check the GNU Mailman version
    /usr/share/mailman/bin/version 

##### Run the check permissions script, and run it again with the -f flag until all of the problems are fixed
    /usr/share/mailman/bin/check_perms
    /usr/share/mailman/bin/check_perms > ~/checked_perms.[yyyy-mm-dd].txt
    /usr/share/mailman/bin/check_perms -f
    /usr/share/mailman/bin/check_perms -f
 
##### ​Set the Mailman site master password
    /usr/share/mailman/bin/mmsitepass [ --- somepassword --- ]
    
##### Review the Defaults file
    less /usr/share/mailman/Mailman/Defaults.py

##### Edit the mm_cfg.py file
*Make sure these values are set. Don't forget the single quotes!*
```
    vim /usr/share/mailman/Mailman/mm_cfg.py
```
```
DEFAULT_URL_HOST = fqdn
DEFAULT_EMAIL_HOST = '[somedomain.whatever]'
MTA = 'Postfix'
```
##### Check the default values for Postfix alias and command
```
grep POSTFIX_ALIAS_CMD /usr/share/mailman/Mailman/Defaults.py
```
*Should return: POSTFIX_ALIAS_CMD = '/usr/sbin/postalias'*
```
grep POSTFIX_MAP_CMD /usr/share/mailman/Mailman/Defaults.py
```
*Should return: POSTFIX_MAP_CMD = '/usr/sbin/postmap'*

##### Create a mailman.conf file
    vim /etc/httpd/conf.d/mailman.conf
```

```

##### Run the bin/genaliases script to initialize the aliases file
    /usr/share/mailman/bin/genaliases

##### Make sure that the owner of the data/aliases and data/aliases.db file is mailman, that the group owner for those files is mailman, or whatever user and group you used in the configure command, and that both files are group writable.
    ls -la /etc/mailman/aliases*
    chown mailman:mailman /etc/mailman/aliases*
    ls -la /etc/mailman/aliases*
    chmod g+w /etc/mailman/aliases*
    ls -la /etc/mailman/aliases*
    
##### Make sure the Apache config file has an entry like this for Mailman
```xml
ScriptAlias /mailman/ /usr/lib/mailman/cgi-bin/
<Directory /usr/lib/mailman/cgi-bin/>
    AllowOverride None
    Options ExecCGI
    Order allow,deny
    Allow from all
</Directory>

Alias /pipermail/ /var/lib/mailman/archives/public/
<Directory /var/lib/mailman/archives/public>
    Options MultiViews FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
    AddDefaultCharset Off
</Directory>
```
##### Restart Apache
    /etc/init.d/httpd status
    /etc/init.d/httpd restart
##### ​Read the Mailman init script
    cat /etc/init.d/mailman
##### Copy the Mailman init script to /etc/init.d/
    cp /usr/lib/mailman/scripts/mailman /etc/init.d/mailman
##### Edit the master copy of crontab.in
    nano /usr/lib/mailman/cron/crontab.in
##### Comment out this line 
    #0,5,10,15,20,25,30,35,40,45,50,55 * * * * mailman /usr/lib/mailman/cron/gate_news
##### Copy the crontab.in file to /etc/cron.d/mailman
    cp /usr/lib/mailman/cron/crontab.in /etc/cron.d/mailman
##### Make sure the the mailman user _does not_ have a crontab
    crontab -u mailman -l
    ls -la /var/spool/cron/
##### ​Tell Mailman to start every time you reboot your system
    chkconfig --add mailman
##### Start Mailman
    /etc/init.d/mailman start
* Open a web browser, and log into the admin page of a test list.
* Subscribe a Yahoo email address to the test list and send an email message to the test list from a Gmail account. 
* Reply from the Yahoo account to the message sent from the Gmail account. 
* Check the Gmail account for the reply from the Yahoo account.
* If the Gmail account does not get the message from the Yahoo account, the problem is confirmed. 
* Check the mail log to see what happened when you sent the message from Yahoo and from Gmail. 
```
cat /var/log/maillog
```
##### To fix the problem...

* Open a web browser, and log into the admin page of a test list.
* For the option of “from_is_list” select “Munge From.” 
* Send a test message to the list from a Gmail account. 
* Reply from the Yahoo account to the message sent from the Gmail account. 
* Check the Gmail account for the reply from the Yahoo account.
* ​If the Gmail account gets the message from the Yahoo account, the problem is fixed. 
