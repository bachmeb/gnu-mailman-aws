# 2.1.18.install

This project describes the process of installing GNU Mailman 2.18 on an Amazon AWS EC2 instance. Currently the default package available in Amazon Linux is version 2.1.15. Version 2.1.18 of GNU Mailman includes a fix to allow mail to be delivered to subscribers whose email service bounces messages not conforming to the DMARC standard. 

###References
* http://tombuntu.com/index.php/2009/12/22/send-outgoing-email-with-postfix/
* http://www.uponmyshoulder.com/blog/2010/set-up-a-mail-server-on-amazon-ec2/
* http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html
* https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/3/html/Reference_Guide/s1-bind-zone.html
* http://www.mail-tester.com/spf/godaddy
* http://www.openspf.org/FAQ/Common_mistakes
* http://www.tldp.org/LDP/nag2/x-087-2-mail.routing.html
* https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html
* http://cybart.com/how-to-install-and-configure-postfix-on-amazon-ec2/
* http://www.gnu.org/software/mailman/mailman-install/
* http://www.yolinux.com/TUTORIALS/LinuxTutorialMailman.html
* http://minhtech.com/featuredlinux/install-and-configure-mailman/
* http://docs.aws.amazon.com/ses/latest/DeveloperGuide/smtp-issues.html
* http://www.postfix.org/BASIC_CONFIGURATION_README.html
* http://www.postfix.org/VIRTUAL_README.html
* http://www.postfix.org/postconf.1.html
* http://www.scriptinstallation.in/smtpd_banner.html
* http://exchangepedia.com/2006/12/should-mx-record-point-to-cname-records-aliases.html
* http://www.wizcrafts.net/iptables-blocklists.html
* http://www.gnu.org/software/mailman/mailman-install/node9.html
* http://wiki.list.org/DOC/After%20installing%20the%20cronjob%20you%20receive%20a%20-bin-sh-%20mailman-%20command%20not%20found%20error
* http://ss64.com/bash/crontab.html
* http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-hostname.html
* http://unix.stackexchange.com/questions/58243/which-name-should-be-used-for-myhostname-in-postfixs-main-cf
* https://forums.aws.amazon.com/thread.jspa?threadID=110311
* https://forums.aws.amazon.com/thread.jspa?threadID=91260
* https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-services-chkconfig.html

##### Create a new vm
* https://aws.amazon.com/ec2/

##### Step 1: Choose an Amazon Machine Image (AMI)
	Amazon Linux AMI 2015.09.1 (HVM), SSD Volume Type - ami-f0091d91

##### Step 2: Choose an Instance Type
	Family: General purpose
	Type: t2.micro
	vCPUs: 1
	Memory: 1
	Instance Storage: EBS only
	EBS-Optimized: -
	Network Performance: Low to Moderate

##### Step 3: Configure Instance Details
	Number of instances: 	1
	Network: (default)
	Subnet: No preference (default subnet in any Availability Zone)
	EBS-optimized: No
	Monitoring: No
	Termination protection: YES <---- UPDATE THIS
	Shutdown behavior: Stop
	IAM role: None
	Tenancy: default
	Host ID: 
	Affinity: Off
	Kernel ID: Use default
	RAM disk ID: Use default
	User data: 
	Assign Public IP: Use subnet setting (Enable)
	Network interfaces: 
	Purchasing option: On demand

##### Step 4: Add Storage
	Volume Type: Root
	Device: /dev/xvda
	Snapshot: snap-ad8e61f8
	Size (GiB): 8
	Volume Type: General Purpose SSD (GP2)
	IOPS: 24 / 3000
	Delete on Termination: Yes
	Encrypted: Not Encrypted

##### Step 5: Tag Instance
	Key: Name
	Value:

##### Step 6: Configure Security Group 
*Allow all ICMP and TCP traffic from your IP address. SSH communicates via TCP on port 22.*
```
Type       Protocol   Port Range   Source
All TCP    TCP        0 - 65535    your ip address/32
All ICMP   All        N/A          your ip address/32
```

##### Download the key pair and change the mode to 400
	chmod 400 pemfile.pem

##### Create an Elastic IP address
*This is important. Read up on the Elastic IP concept.*
* http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html

##### Check Spam Haus and What is My IP Address to see if the Elastic IP address has already been added to the block list
* http://www.spamhaus.org/lookup/
* http://whatismyipaddress.com/blacklist-check

##### Assign the Elastic IP address to your running ec2 instance
* http://aws.amazon.com/

##### Create an MX record in the DNS zone file hosted by your DNS provider
[*Most Internet sites want to direct all inbound mail to a highly available mail server that is capable of handling all this traffic and have it distribute the mail locally. To announce this service, the site publishes a so-called MX record for its local domain in its DNS database. MX stands for Mail Exchanger and basically states that the server host is willing to act as a mail forwarder for all mail addresses in the domain.*](http://www.tldp.org/LDP/nag2/x-087-2-mail.routing.html)
```
; A Records
@	600	IN	A	[000.000.000.000] <-- The Elastic IP address
mail	600	IN	A [000.000.000.000] <-- The Elastic IP address

; CNAME Records
ftp	600	IN	CNAME	@
www	600	IN	CNAME	@

; MX Records
@	600	IN	MX	1 [mail.somedomain.whatever]
```

##### Add a SPF record to the DNS zone file.
[*SPF's purpose is to publish a list of outgoing mail servers. Any servers that do not deliver mail to the world, such as web servers or incoming-only mail servers, should not be listed.*](http://www.openspf.org/FAQ/Common_mistakes)
```
; TXT Records
@	600	IN	TXT	"v=spf1 mx ~all"
```
##### Complete the Request to Remove Email Sending Limitations form. Amazon owns reverse DNS for the EC2 instance. 
* https://aws.amazon.com/forms/ec2-email-limit-rdns-request?catalog=true&isauthcode=true

##### Do a nslookup from your local machine to confirm the current status of reverse DNS.
*At this point, it will probably still resolve to ec2-[your elastic ip address].us-west-2.compute.amazonaws.com. My reverse DNS resolved correctly about an hour after I submitted my request to remove email sending limitations.*  
```
nslookup -type=ptr [your elastic ip address]
```
##### Ping the Elastic IP address to confirm that ICMP traffic is allowed from your IP address
	ping [ec2.ipa.ddr.ess]

##### Ping the domain name to see if DNS has been updated to point to the Elastic IP address
	ping [somedomain.whatever]
    
##### Connect via SSH
*Either:*
```
ssh -i pemfile.pem ec2-user@[ec2.ipa.ddr.ess]
```
*Or:*
```
ssh -i pemfile.pem ec2-user@[somedomain.whatever]
```
##### Check the Linux distro version
	cat /proc/version
```c
// Linux version 4.1.17-22.30.amzn1.x86_64 (mockbuild@gobi-build-60009) 
// (gcc version 4.8.3 20140911 (Red Hat 4.8.3-9) (GCC) ) 
// #1 SMP Fri Feb 5 23:44:22 UTC 2016
```
##### Check the time
	date
	
##### List the available time zones
	ls /usr/share/zoneinfo/

##### Update the /etc/sysconfig/clock file with your time zone
	sudo nano /etc/sysconfig/clock
```
ZONE="America/New_York"
UTC=false
```
##### Create a symbolic link between /etc/localtime and your time zone file
	sudo ln -sf /usr/share/zoneinfo/America/New_York /etc/localtime

##### Check the time
	date

*[When you launch an instance, it is assigned a hostname that is a form of the private, internal IP address. A typical Amazon EC2 private DNS name looks something like this: ip-12-34-56-78.us-west-2.compute.internal, where the name consists of the internal domain, the service (in this case, compute), the region, and a form of the private IP address. Part of this hostname is displayed at the shell prompt when you log into your instance (for example, ip-12-34-56-78). Each time you stop and restart your Amazon EC2 instance (unless you are using an Elastic IP address), the public IP address changes, and so does your public DNS name, system hostname, and shell prompt. Instances launched into EC2-Classic also receive a new private IP address, private DNS hostname, and system hostname when they're stopped and restarted; instances launched into a VPC don't.](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-hostname.html)*

*[If you have a public DNS name registered for the IP address of your instance (such as webserver.mydomain.com), you can set the system hostname so your instance identifies itself as a part of that domain. This also changes the shell prompt so that it displays the first portion of this name instead of the hostname supplied by AWS (for example, ip-12-34-56-78).](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-hostname.html)*

##### Edit the sysconfig network file
	sudo nano /etc/sysconfig/network

*Rather than set the hostname of this machine to match a fully qualified domain name, this tutorial assumes we want the server to have a unique hostname that is different than any of the hostnames we define in the public DNS file. The mailman listinfo web page will be addressble by a web address on a domain defined in DNS, but the local hostname of the server does not have to match the public web address of the mailman listinfo page. We should be able to configure mailman to run on a server with any local hostname, and still offer the mailman listinfo page at a web address on a domain defined in DNS.*

<!---
##### Set the HOSTNAME to the fqdn
HOSTNAME=[somehost.somedomain.whatever]
-->
##### Set the HOSTNAME to be any name you would like for the virtual server
	HOSTNAME=[somehost].localdomain

##### Edit the hosts file
	sudo nano /etc/hosts
```
127.0.0.1  [somehost] [somehost].localdomain localhost localhost.localdomain
```

##### Reboot the system to pick up the new hostname and time zone information in all services and applications
	sudo reboot

##### Connect via SSH
*Either:*
```
ssh -i pemfile.pem ec2-user@[ec2.ipa.ddr.ess]
```
*Or:*
```
ssh -i pemfile.pem ec2-user@[somedomain.whatever]
```
##### Check the time
	date

##### Switch to super user
	sudo su
	
##### Check the default options configured for adding a user on this system
	useradd -D
    
##### Create a non-admin user account for yourself
	useradd [your user account name]
    
##### Set your password
	passwd [your user account name]

##### Edit sudoers file
	vim /etc/sudoers
	:$

##### Add your account to sudoers file
	## LET ME SUDO
	[your user account name] ALL=(ALL) ALL

##### Switch to your user account. Be sure to use the -l switch.
	su -l [your user account name]

##### Ask who am I?
	whoami

##### Echo the value of the $HOME environment variable
	echo $HOME
	
##### Go home
	cd ~
	pwd

##### Change the command prompt to show your username at the fqdn
	export PS1='[\u@\H \W]\$'

##### Read your .bashrc file
	cat .bashrc
	
##### Add the PS1 command to your .bashrc file
	echo 'PS1="[\u@\H \W]\$ "'>>~/.bashrc

##### Read your .bashrc file
	cat .bashrc
	
##### Check the hostname of the ec2 instance
	hostname

##### Check the DNS domain name of the ec2 instance
	dnsdomainname

##### Get the IP address of the internal name server
	cat /etc/resolv.conf

##### Check the routing table
	route

##### Check the internal IP address
	ifconfig

##### Check the external IP address
	wget http://ipinfo.io/ip -qO -

##### Run a speed test (just for fun)
```
wget https://raw.github.com/sivel/speedtest-cli/master/speedtest_cli.py
chmod +x speedtest_cli.py
./speedtest_cli.py
```

##### Install system updates
	sudo yum update
	
##### Install the Apache HTTP server
	yum search httpd
	sudo yum install httpd
	yum list installed | grep httpd

##### See where HTTPD was installed
	whereis httpd

##### Find the httpd.conf file
	sudo find / -name httpd.conf

##### Edit httpd.conf
	sudo vim /etc/httpd/conf/httpd.conf
	/ServerN

##### Add this line to httpd.conf
	ServerName localhost

##### See if a service is listening on port 80
	sudo lsof -ni:80

##### Check the status of the httpd service
	sudo service httpd status

##### Check the run level
	runlevel
	
##### See if httpd is set to start for run levels 0 through 6
	chkconfig --list httpd

##### Set httpd to start in run levels 2, 3, 4, and 5
	sudo chkconfig httpd on

##### See if httpd is set to start for run level 3
	chkconfig --list httpd
	
##### Start the httpd service
	sudo service httpd start

##### See if a service is listening on port 80
	sudo lsof -ni:80
    
##### Install lynx
	sudo yum install lynx

##### Visit the test page for the Apache HTTP server on localhost 
	lynx localhost

##### Install telnet on the EC2 instance
	sudo yum install telnet

##### Telnet to port 80 on localhost
	telnet localhost 80
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// ^]
// 
// telnet> q
// Connection closed.
```

##### Add a rule to the AWS security group allowing TCP traffic on port 80 from anywhere
```
Type   Protocol   Port Range   Source
HTTP   TCP        80           0.0.0.0/0
```

##### Telnet to port 80 on the EC2 instance from your local machine
	telnet [somedomain.whatever] 80
```c
// Trying [ec2 ip address]...
// Connected to [somedomain.whatever].
// Escape character is '^]'.
// ^]
// 
// telnet> q
// Connection closed.
```

##### Visit the test page for the Apache HTTP server from a web browser on your local machine
http://[somedomain.whatever]

*[Before you look at Sendmail or PostFix, you should know about a subsystem of Fedora Core and Red Hat Linux that controls which MTA the system uses. It is critical that you understand this MTA control system, since you need to know which MTA is in use before you can troubleshoot related e-mail problems.](http://books.gigatux.nl/mirror/linuxtroubleshooting/9149final/LiB0159.html)*

##### Check the MTA
	alternatives --display mta
```c
// mta - status is auto.
//  link currently points to /usr/sbin/sendmail.sendmail
// /usr/sbin/sendmail.sendmail - priority 90
//  slave mta-mailq: /usr/bin/mailq.sendmail
//  slave mta-newaliases: /usr/bin/newaliases.sendmail
//  slave mta-rmail: /usr/bin/rmail.sendmail
//  slave mta-sendmail: /usr/lib/sendmail.sendmail
//  slave mta-pam: /etc/pam.d/smtp.sendmail
//  slave mta-sendmailman: /usr/share/man/man8/sendmail.sendmail.8.gz
//  slave mta-mailqman: /usr/share/man/man1/mailq.sendmail.1.gz
//  slave mta-newaliasesman: /usr/share/man/man1/newaliases.sendmail.1.gz
//  slave mta-aliasesman: /usr/share/man/man5/aliases.sendmail.5.gz
// Current `best' version is /usr/sbin/sendmail.sendmail.
```
##### Ask where is sendmail?
	whereis sendmail
	
##### Check to see if sendmail is set to run at boot time for the current run level
	chkconfig --list sendmail
```c
// sendmail    	0:off	1:off	2:on	3:on	4:on	5:on	6:off
```
##### See if a service is listening on port 25
	sudo lsof -ni:25
```c
// COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
// sendmail 2510 root    4u  IPv4   9784      0t0  TCP 127.0.0.1:smtp (LISTEN)
```
    
##### Telnet to localhost on port 25. The connection should be accepted by sendmail.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// 220 ur.localdomain ESMTP Sendmail 8.14.4/8.14.4; Mon, 22 Feb 2016 14:18:34 -0500
//
// telnet> q
// Connection closed.
```

##### Try to telnet from your local machine to the Amazon SES SMTP endpoint on port 25.  
*If you cannot connect to the Amazon SES SMTP endpoint using telnet, then something in your network (for example, a firewall) is blocking outbound connections over the port you're trying to use.*  
```
telnet email-smtp.us-west-2.amazonaws.com 25
```
```c
// Trying 54.69.81.169...
// Connected to email-smtp.us-west-2.amazonaws.com.
// Escape character is '^]'.
// 220 email-smtp.amazonaws.com ESMTP SimpleEmailService-1207562731 kV5Wz2FTan1oE6hWxLS6
```

##### Add a rule to the AWS security group allowing SMTP traffic from anywhere
```
Type   Protocol   Port Range   Source
SMTP   TCP        25           0.0.0.0/0
```

##### Try to telnet to the EC2 instance on port 25 from your local machine. The connection should be refused.
	telnet [somedomain.whatever] 25
```c
// Trying [ec2 ip address]...
// telnet: connect to address [ec2 ip address]: Connection refused
// telnet: Unable to connect to remote host
```

##### Go to Pingability and check to see if the mail server in the MX record is responding correctly.
* https://pingability.com/zoneinfo.jsp  

*Should return:*
```
Mail Server Info
Info Type  Message
Error	   There was a problem while talking with the mail server. Got 'ConnectException: Connection refused'
```

##### Stop sendmail
	sudo service sendmail status
	sudo service sendmail stop
```c
// Shutting down sm-client:                                   [  OK  ]
// Shutting down sendmail:                                    [  OK  ]
```

##### Telnet to localhost on port 25. The connection should be refused.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// telnet: connect to address 127.0.0.1: Connection refused
```

##### Install Postfix
	yum search postfix
	sudo yum install postfix

##### Ask where is postfix?
	whereis postfix

##### Check the MTA
	alternatives --display mta
```c
/*
mta - status is auto.
 link currently points to /usr/sbin/sendmail.sendmail
/usr/sbin/sendmail.sendmail - priority 90
 slave mta-pam: /etc/pam.d/smtp.sendmail
 slave mta-mailq: /usr/bin/mailq.sendmail
 slave mta-newaliases: /usr/bin/newaliases.sendmail
 slave mta-rmail: /usr/bin/rmail.sendmail
 slave mta-sendmail: /usr/lib/sendmail.sendmail
 slave mta-mailqman: /usr/share/man/man1/mailq.sendmail.1.gz
 slave mta-newaliasesman: /usr/share/man/man1/newaliases.sendmail.1.gz
 slave mta-aliasesman: /usr/share/man/man5/aliases.sendmail.5.gz
 slave mta-sendmailman: /usr/share/man/man8/sendmail.sendmail.8.gz
/usr/sbin/sendmail.postfix - priority 30
 slave mta-pam: /etc/pam.d/smtp.postfix
 slave mta-mailq: /usr/bin/mailq.postfix
 slave mta-newaliases: /usr/bin/newaliases.postfix
 slave mta-rmail: /usr/bin/rmail.postfix
 slave mta-sendmail: /usr/lib/sendmail.postfix
 slave mta-mailqman: /usr/share/man/man1/mailq.postfix.1.gz
 slave mta-newaliasesman: /usr/share/man/man1/newaliases.postfix.1.gz
 slave mta-aliasesman: /usr/share/man/man5/aliases.postfix.5.gz
 slave mta-sendmailman: /usr/share/man/man1/sendmail.postfix.1.gz
Current `best' version is /usr/sbin/sendmail.sendmail.
*/
```

##### Switch the MTA from Sendmail to Postfix
*[The sendmail.postfix binary is actually the postfix binary with an additional Sendmail compatibility wrapper included that can take some Sendmail-formatted command-line options.](http://books.gigatux.nl/mirror/linuxtroubleshooting/9149final/LiB0159.html)*
```
sudo alternatives --set mta /usr/sbin/sendmail.postfix
```

##### Check the MTA
	alternatives --display mta
```c
// mta - status is manual.
// link currently points to /usr/sbin/sendmail.postfix
```

##### Check to see if sendmail or postfix is set to run at boot time for the current run level
	chkconfig | grep sendmail
	chkconfig | grep postfix

##### Start Postfix
	sudo service postfix status
	sudo service postfix start

##### See if a service is listening on port 25
    sudo lsof -ni:25
```c
// COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
// master  3398 root   12u  IPv4  23182      0t0  TCP 127.0.0.1:smtp (LISTEN)
```
    
##### Telnet to localhost on port 25. The connection should be accepted by postfix.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// 220 [somehost].localdomain ESMTP Postfix
```

##### Telnet to [somedomain.whatever] on port 25. The connection should be refused.
	telnet [somedomain.whatever] 25
```c
// Trying [ec2 ip address]...
// telnet: connect to address [ec2 ip address]: Connection refused
```

##### Check the system mail log for connection events
	sudo cat /var/log/maillog

<!---
*[If you want to simulate a reboot without actually rebooting your system, just toggle over to another runlevel and then back to your production default runlevel. After doing this, anything set to run in your default runlevel should start up if not already running.](http://books.gigatux.nl/mirror/linuxtroubleshooting/9149final/LiB0159.html)*
```
# runlevel
N 3
# init 4
# init 3
# /etc/init.d/postfix status
master (pid 5904) is running
```
-->

##### Create a test account
	sudo useradd --create-home -s /sbin/nologin test
	sudo passwd test
	ls /home

##### Install mail
	sudo yum install mail

##### Send a message to the test account from your local account
	mail test
```
Subject: [time of day]
this is a test message
.
```

##### Check to see if the message was delivered
	sudo cat /var/spool/mail/test

*[By default, Postfix configuration files are in /etc/postfix. The two most important files are main.cf and master.cf; these files must be owned by root. In /etc/postfix/main.cf you will have to set up a minimal number of configuration parameters.](http://www.postfix.org/BASIC_CONFIGURATION_README.html)*

##### Read the Postfix config file
	less /etc/postfix/main.cf

##### Show the contents of the Postfix config file without any comments
	grep -vE "^\s*(#|$)" /etc/postfix/main.cf
    
##### Show the default Postfix configuration values
	postconf -d

##### Show the current Postfix configuration values
	postconf

##### Compare the default setting with the current settings
	postconf > postconf.txt
	postconf -d > postconf-d.txt
	diff postconf.txt postconf-d.txt 

##### Rename the main.cf file
	sudo mv /etc/postfix/main.cf /etc/postfix/main.cf.backup

##### Make a blank main.cf file
	sudo touch /etc/postfix/main.cf

##### Reload postfix
	sudo postfix reload

*Reloading postfix with a blank main.cf file removes any custom settings and allows the MTA to run with the default settings.*

##### Telnet to localhost on port 25. The connection should be accepted by postfix.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// 220 [somehost].localdomain ESMTP Postfix
```

*[Postfix configuration parameters resemble shell variables, with two important differences: the first one is that Postfix does not know about quotes like the UNIX shell does. You specify a configuration parameter as parameter = value and you use it by putting a "$" character in front of its name like so: other_parameter = $parameter. You can use $parameter before it is given a value (that is the second main difference with UNIX shell variables). The Postfix configuration language uses lazy evaluation, and does not look at a parameter value until it is needed at runtime.](http://www.postfix.org/BASIC_CONFIGURATION_README.html#syntax)*

##### Set inet_interfaces
*[The network interface addresses that this mail system receives mail on. Specify "all" to receive mail on all network interfaces (default), and "loopback-only" to receive mail on loopback network interfaces only (Postfix version 2.2 and later). The parameter also controls delivery of mail to user@[ip.address]. Note 1: you need to stop and start Postfix when this parameter changes. Note 2: address information may be enclosed inside [], but this form is not required here.](http://www.postfix.org/postconf.5.html#inet_interfaces)*
```
postconf inet_interfaces
sudo postconf -e "inet_interfaces = all"
```

##### Read the main.cf file
	cat /etc/postfix/main.cf

##### See which settings in master.cf are overruled by main.cf
	postconf -n

##### Restart postfix
	sudo postfix stop
	sudo postfix start

##### Telnet to [somedomain.whatever] on port 25. The connection should be accepted by postfix.
	telnet [somedomain.whatever] 25
```c
// 
// Trying [ec2 ip address]...
// Connected to [somedomain.whatever].
// Escape character is '^]'.
// 220 [somehost].localdomain ESMTP Postfix
```

##### Go to Pingability and check to see if the mail server in the MX record is responding correctly.
* https://pingability.com/zoneinfo.jsp

*Should respond with:*
```
Mail Server Info
Info Type	Message
Heads-up	The mail server rejected the email address 'abuse@proximal.us' (554 5.7.1 <abuse@proximal.us>: Relay access denied). It should have accepted the address.
Information	The mail server correctly rejected email to 'email_validation_service@domaincheckingservice.pingability.com' (554 5.7.1 <email_validation_service@domaincheckingservice.pingability.com>: Relay access denied)
```

##### Set the smtpd banner
*[smtpd_banner is the text that follows the 220 status code in the SMTP greeting banner. Some people like to see the mail version advertised. By default, Postfix shows no version. You MUST specify $myhostname at the start of the text. This is required by the SMTP protocol.](http://www.postfix.org/postconf.5.html#smtpd_banner)*
```
postconf -d smtpd_banner
sudo postconf -e "smtpd_banner = \$myhostname ESMTP \$mail_name HELLO WORLD"
postconf smtpd_banner
```

##### Read the main.cf file
	cat /etc/postfix/main.cf

##### See which settings in master.cf are overruled by main.cf
	postconf -n
	
##### Telnet to localhost on port 25. The connection should be accepted by postfix.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// 220 [somehost].localdomain ESMTP Postfix HELLO WORLD
```

##### Set myhostname
*[The internet hostname of this mail system. The default is to use the fully-qualified domain name (FQDN) from gethostname(), or to use the non-FQDN result from gethostname() and append ".$mydomain". $myhostname is used as a default value for many other configuration parameters.](http://www.postfix.org/postconf.5.html#myhostname)*
```
postconf -d myhostname
sudo postconf -e "myhostname = [somehost.somedomain.whatever]"
postconf myhostname
```
	
##### Telnet to localhost on port 25. The connection should be accepted by postfix and the hostname should be changed.
	telnet localhost 25
```c
// Trying 127.0.0.1...
// Connected to localhost.
// Escape character is '^]'.
// 220 [somehost.somedomain.whatever] ESMTP Postfix HELLO WORLD
```

##### Set mydomain
*[The internet domain name of this mail system. The default is to use $myhostname minus the first component, or "localdomain" (Postfix 2.3 and later). $mydomain is used as a default value for many other configuration parameters.](http://www.postfix.org/postconf.5.html#mydomain)*
```
postconf -d mydomain
sudo postconf -e "mydomain = [somedomain.whatever]"
postconf mydomain
```

##### Set myorigin
*[The domain name that locally-posted mail appears to come from, and that locally posted mail is delivered to. The default, $myhostname, is adequate for small sites. If you run a domain with multiple machines, you should (1) change this to $mydomain and (2) set up a domain-wide alias database that aliases each user to user@that.users.mailhost.](http://www.postfix.org/postconf.5.html#myorigin)*
```
postconf -d myorigin
sudo postconf -e "myorigin = \$mydomain"
postconf myorigin
```	

##### Send a message to an external email address
	whoami
	mail [external]@[email.address]
```
Subject: [time of day]
Test message from [your account name]
.
```

##### Check the external account to see if the message was delivered. 
* gmail.com

##### Set mydestination
*[The list of domains that are delivered via the $local_transport mail delivery transport. By default this is the Postfix local(8) delivery agent which looks up all recipients in /etc/passwd and /etc/aliases. The SMTP server validates recipient addresses with $local_recipient_maps and rejects non-existent recipients. The default mydestination value specifies names for the local machine only. On a mail domain gateway, you should also include $mydomain. The $local_transport delivery method is also selected for mail addressed to user@[the.net.work.address] of the mail system (the IP addresses specified with the inet_interfaces and proxy_interfaces parameters). Warnings: Do not specify the names of virtual domains - those domains are specified elsewhere. See VIRTUAL_README for more information. Do not specify the names of domains that this machine is backup MX host for. By default, the Postfix SMTP server rejects mail for recipients not listed with the local_recipient_maps parameter. 
](http://www.postfix.org/postconf.5.html#mydestination)*
```
postconf -d mydestination
sudo postconf -e "mydestination = \$mydomain, \$myhostname, localhost"
postconf mydestination
```

##### Reply to the message sent to the external account
* gmail.com

##### Install Mutt
	sudo yum install mutt

##### Check to see if the reply was delivered
	mutt -f /var/spool/mail/[your user account name]

##### Set virtual_alias_domains 
*[Postfix can be configured to be final destination for any number of additional domains. These domains are called hosted, because they are not directly associated with the name of the machine itself. Hosted domains are usually implemented with the virtual alias domain address class and/or with the virtual mailbox domain address class.](http://www.postfix.org/VIRTUAL_README.html)*
```
postconf -d virtual_alias_domains
postconf virtual_alias_domains
postconf -e "virtual_alias_domains = [somedomain.whatever]"
```

##### Set virtual_alias_maps
*[Optional lookup tables that alias specific mail addresses or domains to other local or remote address.](http://www.postfix.org/postconf.5.html#virtual_alias_maps)*
```
postconf -e "virtual_alias_maps = hash:/etc/postfix/virtual"
```

##### [Execute the command "postfix reload" after changing the main.cf file.](http://www.postfix.org/VIRTUAL_README.html)
	postfix reload
	
##### Read the postfix virtual file
	less /etc/postfix/virtual

##### Rename the postfix virtual file 
	sudo mv /etc/postfix/virtual /etc/postfix/virtual.backup

##### Make a new postfix virtual file
	sudo nano /etc/postfix/virtual

##### Add these lines to /etc/postfix/virtual
*[With virtual alias domains, each hosted address is aliased to a local UNIX system account or to a remote address. ](http://www.postfix.org/VIRTUAL_README.html)*
```
aka@[somedomain.whatever] test
```

##### [Execute the command "postmap /etc/postfix/virtual" after changing the virtual file](http://www.postfix.org/VIRTUAL_README.html)
	sudo postmap /etc/postfix/virtual

##### Use postmap to look for the new alias added to the virtual file
	postmap -q aka@spoonerspizza.com hash:/etc/postfix/virtual

##### Send a message from your local account to the alias email address
	mail aka@[somedomain.whatever]

##### See if the message was delivered
	sudo cat /var/spool/mail/test

##### Send a message from your local account to the local name of the alias account
	mail aka
```
Subject: [time of day]
Local message from me to aka@[somedomain.whatever]
.
```

##### Check to see if it was delivered
	sudo mailx -f /var/spool/mail/test

##### Check the mail log for repetitive, unsolicited, foreign traffic
	cat /var/log/maillog | grep "connect from"

##### Configure iptables to block traffic from malicious hosts
* ./iptables.config.md

##### Check python version. Should be 2.7+
	python -V
	
##### Download dnspython
	cd /opt
	ls
	sudo wget --no-check-certificate https://pypi.python.org/packages/source/d/dnspython/dnspython-1.11.1.zip
	ls -la

##### Unzip dnspython
	sudo unzip dnspython-1.11.1.zip
	ls 

##### Install dnspython
	cd dnspython-1.11.1
	sudo python setup.py install

##### Check to see if the filesystem is mounted with the nosuid option.
	mount

##### Check the available versions of mailman with yum
*The current version available in yum on AWS is 2.1.15. We want version 2.1.18*  
```
yum list available | grep mailman
```
```c
// mailman.x86_64          3:2.1.15-21.20.amzn1          amzn-main   
```

##### Install the GNU Compiler
	sudo yum install gcc

##### See where gcc was installed
	whereis gcc

##### Check the gcc version
	gcc --version 
    
##### See if Mailman is installed
	yum list installed | grep mailman
    
##### Download GNU Mailman 2.1.18
	cd /opt
	sudo wget http://ftp.gnu.org/gnu/mailman/mailman-2.1.18.tgz

##### Extract GNU Mailman
	sudo tar xzf mailman-2.1.18.tgz

##### [Create a mailman user](http://www.gnu.org/software/mailman/mailman-install/node4.html)
	sudo groupadd mailman
	sudo useradd mailman -c "GNU Mailman" -g mailman -d /dev/null -s /sbin/nologin

##### Check the user id and group ids of mailman and apache
	cat /etc/group | grep -E '(mailman|apache)'
	cat /etc/passwd | grep -E '(mailman|apache)'

##### Create the Mailman $prefix directory
	mkdir /usr/lib/mailman
	chgrp mailman /usr/lib/mailman
	chmod a+rx,g+ws /usr/lib/mailman

##### Create the Mailman Var directory
	mkdir /var/lib/mailman
	chgrp mailman /var/lib/mailman
	chmod a+rx,g+ws /var/lib/mailman
    
##### [Before you can install Mailman, you must run configure to set various installation options your system might need.](http://www.gnu.org/software/mailman/mailman-install/node7.html)
* Set the $prefix directory to /usr/lib/mailman. 
* Set the Var directory to /var/lib/mailman. 
* Set the group id of the mail wrapper to mailman. 
* Set the group id of the web server wrapper to apache. 
```
cd mailman-2.1.18/
./configure --prefix=/usr/lib/mailman/ --with-var-prefix=/var/lib/mailman --with-mail-gid=mailman --with-cgi-gid=apache
```
##### [Once you've run configure, you can simply run make, then make install to build and install Mailman.](http://www.gnu.org/software/mailman/mailman-install/node8.html)
	make
	make install

##### Ask where is mailman?
	whereis mailman

##### Check the GNU Mailman version
	/usr/lib/mailman/bin/version 
```c
// Using Mailman version: 2.1.18
```
##### [After you've run make install, you should check that your installation has all the correct permissions and group ownerships by running the check_perms script.](http://www.gnu.org/software/mailman/mailman-install/node9.html)
*Run the check permissions script, and run it again with the -f flag until all of the problems are fixed*
```
/usr/lib/mailman/bin/check_perms
/usr/lib/mailman/bin/check_perms > ~/checked_perms.$(date "+%Y-%m-%d.%H%M%S").txt
/usr/lib/mailman/bin/check_perms -f
/usr/lib/mailman/bin/check_perms -f
```

##### Read httpd.conf
	vim /etc/httpd/conf/httpd.conf

##### Find the section of the document which instructs the HTTP server to load config files from the config directory
	/conf.d

##### [You must configure your web server to enable CGI script permission in the $prefix/cgi-bin to run CGI scripts. You want to be very sure that the user id under which your CGI scripts run is not in the mailman group you created above, otherwise private archives will be accessible to anyone.](http://www.gnu.org/software/mailman/mailman-install/node10.html)
    vim /etc/httpd/conf.d/mailman.conf
```xml
ScriptAlias /mailman/ /usr/lib/mailman/cgi-bin/
<Directory /usr/lib/mailman/cgi-bin/>
    AllowOverride None
    Options ExecCGI
    Order allow,deny
    Allow from all
</Directory>

Alias /pipermail/ /var/lib/mailman/archives/public/
<Directory /var/lib/mailman/archives/public>
    Options MultiViews FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
    AddDefaultCharset Off
</Directory>

RedirectMatch ^/mailman[/]*$ http://[someshost.somedomain.whatever]/mailman/listinfo
```

##### Restart Apache
	/etc/init.d/httpd status
	/etc/init.d/httpd restart

##### Visit the GNU Mailman page
	http://[someshost.somedomain.whatever]/mailman

##### Read the section of httpd.conf which instructs the HTTP server to load icons
	vim /etc/httpd/conf/httpd.conf
	/AddIcon

##### [Copy the Mailman, Python, and GNU logos to a location accessible to your web server.](http://www.gnu.org/software/mailman/mailman-install/node10.html)
	sudo cp /usr/lib/mailman/icons/* /var/www/icons/

##### Reload the GNU Mailman page
*The icons should load...*
```
http://[someshost.somedomain.whatever]/mailman
```

*[Mailman has a large number of site-wide configuration options which you should now review and change according to your needs. Some of the options control how Mailman interacts with your environment, and other options select defaults for newly created lists. The full set of site-wide defaults lives in the $prefix/Mailman/Defaults.py file, however you should never modify this file! Instead, change the mm_cfg.py file in that same directory. You only need to add values to mm_cfg.py that are different than the defaults in Defaults.py, and future Mailman upgrades are guaranteed never to touch your mm_cfg.py file. The Defaults.py and mm_cfg.py are both Python files so valid Python syntax must be maintained or your Mailman installation will break. You should make any changes to mm_cfg.py using the account you installed Mailman under.](http://www.gnu.org/software/mailman/mailman-install/customizing.html)*

##### Read the site defaults file
	view /usr/lib/mailman/Mailman/Defaults.py

##### Read the site defaults file without comments
	grep -vE "^\s*(#|$)" /usr/lib/mailman/Mailman/Defaults.py
	
##### Edit the mm_cfg.py file
```
vim /usr/lib/mailman/Mailman/mm_cfg.py
```
*Make sure these values are set. Don't forget the SINGLE QUOTES ' ' ' ' ' ' ' ' !*
```
DEFAULT_URL_HOST = '[somehost.somedomain.whatever]'
DEFAULT_EMAIL_HOST = '[somedomain.whatever]'
MTA = 'Postfix'
```

##### Set unknown_local_recipient_reject_code in Postfix  
*[When attempting to deliver a message to a non-existent local address, Postfix may return a 450 error code. Since this is a transient error code, Mailman will continue to attempt to deliver the message for DELIVERY_RETRY_PERIOD - 5 days by default.](http://www.gnu.org/software/mailman/mailman-install/node12.html) To prevent this you should configure Postfix so that it returns permanent error code 550 for non-existent local users.*
```
postconf -e "unknown_local_recipient_reject_code = 550"
```
	
##### Confirm that POSTFIX_MAP_CMD is set to '/usr/sbin/postmap'
	grep POSTFIX_ALIAS_CMD /usr/lib/mailman/Mailman/Defaults.py

##### Confirm that POSTFIX_MAP_CMD is set to '/usr/sbin/postmap'
	grep POSTFIX_MAP_CMD /usr/lib/mailman/Mailman/Defaults.py

##### List the contents of the data directory
	ls -l /var/lib/mailman/data/
```c
// total 24
// -rw-r----- 1 root mailman    41 Feb 23 10:47 adm.pw
// -rw-r--r-- 1 root mailman    10 Feb 23 10:44 last_mailman_version
// -rw-r--r-- 1 root mailman 14100 Feb 23 10:44 sitelist.cfg
```
	
##### [Run the bin/genaliases script to initialize your aliases file](http://www.gnu.org/software/mailman/mailman-install/postfix-integration.html)
	sudo /usr/lib/mailman/bin/genaliases

##### List the contents of the data directory
	ls -l /var/lib/mailman/data/
```c
// total 40
// -rw-r----- 1 root mailman    41 Feb 23 10:47 adm.pw
// -rw-rw---- 1 root mailman   355 Feb 23 16:01 aliases
// -rw-r----- 1 root mailman 12288 Feb 23 16:01 aliases.db
// -rw-r--r-- 1 root mailman    10 Feb 23 10:44 last_mailman_version
// -rw-r--r-- 1 root mailman 14100 Feb 23 10:44 sitelist.cfg
```

##### [Make sure that the owner of the data/aliases and data/aliases.db file is mailman, that the group owner for those files is mailman, or whatever user and group you used in the configure command, and that both files are group writable.](http://www.gnu.org/software/mailman/mailman-install/postfix-integration.html)
	ls -la /var/lib/mailman/data/aliases*
	sudo chown mailman:mailman /var/lib/mailman/data/aliases*
	ls -la /var/lib/mailman/data/aliases*
	sudo chmod g+w /var/lib/mailman/data/aliases*
	ls -la /var/lib/mailman/data/aliases*
```c
// -rw-rw---- 1 mailman mailman   355 Feb 23 16:01 /var/lib/mailman/data/aliases
// -rw-rw---- 1 mailman mailman 12288 Feb 23 16:01 /var/lib/mailman/data/aliases.db
```

##### Read the aliases file
	sudo view /var/lib/mailman/data/aliases
```c
# This file is generated by Mailman, and is kept in sync with the
# binary hash file aliases.db.  YOU SHOULD NOT MANUALLY EDIT THIS FILE
# unless you know what you're doing, and can keep the two files properly
# in sync.  If you screw it up, you're on your own.

# The ultimate loop stopper address
mailman-loop: /var/lib/mailman/data/owner-bounces.mbox
```

##### Set alias_maps
```
vim /etc/postfix/main.cf
```
*Add the path to the mailman alias files to the list of values assigned to the alias_maps variable. Note that there should be no trailing .db. Do not include the path to the mailman alias files in your alias_database variable. This is because you do not want Postfix's newaliases command to modify Mailman's aliases.db file, but you do want Postfix to consult aliases.db when looking for local addresses.](http://www.gnu.org/software/mailman/mailman-install/postfix-integration.html)*
```
alias_maps = hash:/etc/aliases, hash:/etc/postfix/aliases, hash:/usr/local/mailman/data/aliases
```

##### [Execute the command "postfix reload" after changing the main.cf file.](http://www.postfix.org/VIRTUAL_README.html)
	postfix reload

### Create a site-wide mailing list
*[After you have completed the integration of Mailman and your mail server, you need to create a ``site-wide'' mailing list. This is the one that password reminders will appear to come from, and it is required for proper Mailman operation. Usually this should be a list called mailman, but if you need to change this, be sure to change the MAILMAN_SITE_LIST variable in mm_cfg.py. ](http://www.gnu.org/software/mailman/mailman-install/site-list.html)*
	  sudo /usr/lib/mailman/bin/newlist mailman
```c
// Enter the email of the person running the list: [your]@[email.address]
Initial mailman password:
Hit enter to notify mailman owner...
```

##### Configure the site list template 
*Any options not named in the sitelist.cfg file won't be changed*
	sudo vim /var/lib/mailman/data/sitelist.cfg

##### Apply the template to the site list
	bin/config_list -i data/sitelist.cfg mailman

##### Review the site list's configuration via the admin pages

##### Subscribe yourself to the site list

### Set up cron

##### ​Read the Mailman init script
	cat /etc/init.d/mailman
    
##### Copy the Mailman init script to /etc/init.d/
	cp /usr/lib/mailman/scripts/mailman /etc/init.d/mailman
    
##### Edit the master copy of crontab.in
	nano /usr/lib/mailman/cron/crontab.in
    
##### Comment out this line 
	#0,5,10,15,20,25,30,35,40,45,50,55 * * * * mailman /usr/lib/mailman/cron/gate_news
    
##### Copy the crontab.in file to /etc/cron.d/mailman
	cp /usr/lib/mailman/cron/crontab.in /etc/cron.d/mailman
    
##### Make sure the the mailman user _does not_ have a crontab
	crontab -u mailman -l
	ls -la /var/spool/cron/
    
##### Copy the mailman startup script to /etc/init.d
	cp scripts/mailman /etc/init.d/mailman

##### ​Tell Mailman to start every time you reboot your system
	chkconfig --add mailman

    
##### Start Mailman
	/etc/init.d/mailman start
	
#### Start the Mailman qrunner
#### Check the hostname settings


	sudo vim /usr/lib/mailman/Mailman/mm_cfg.py
```python
###############################################
# Here's where we get the distributed defaults.

from Defaults import *

##################################################
# Put YOUR site-specific settings below this line.

DEFAULT_URL_HOST = 'mail.[somedomain].[whatever]'
DEFAULT_EMAIL_HOST = '[somedomain].[whatever]'
MTA = 'Postfix'

add_virtualhost(DEFAULT_URL_HOST, DEFAULT_EMAIL_HOST)
add_virtualhost('www.[somedomain].[whatever]','[somedomain].[whatever]')
```


#### Create the site password
##### ​Set the Mailman site master password
	/usr/lib/mailman/bin/mmsitepass [ --- somepassword --- ]
	
#### Create your first mailing list

    
* Open a web browser, and log into the admin page of a test list.
* Subscribe a Yahoo email address to the test list and send an email message to the test list from a Gmail account. 
* Reply from the Yahoo account to the message sent from the Gmail account. 
* Check the Gmail account for the reply from the Yahoo account.
* If the Gmail account does not get the message from the Yahoo account, the problem is confirmed. 
* Check the mail log to see what happened when you sent the message from Yahoo and from Gmail. 
```
cat /var/log/maillog
```
##### To fix the problem...

* Open a web browser, and log into the admin page of a test list.
* For the option of “from_is_list” select “Munge From.” 
* Send a test message to the list from a Gmail account. 
* Reply from the Yahoo account to the message sent from the Gmail account. 
* Check the Gmail account for the reply from the Yahoo account.
* ​If the Gmail account gets the message from the Yahoo account, the problem is fixed. 
