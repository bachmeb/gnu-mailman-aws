# iptables config

This guide explains the process of blocking traffic on an EC2 instance from entire countries and known malicious hosts. 

### References
* http://www.ipdeny.com/ipblocks/data/countries/
* http://www.cyberciti.biz/faq/block-entier-country-using-iptables/
* http://www.parkansky.com/china.htm
* http://www.wizcrafts.net/iptables-blocklists.html
* https://mattwilcox.net/web-development/unexpected-ddos-blocking-china-with-ipset-and-iptables
* https://wiki.centos.org/HowTos/Network/IPTables

##### Check the mail log for 'connect from unknown entries'
	sudo cat /var/log/maillog | grep 'connect from unknown'

##### Get just the IP addresses
	sudo cat /var/log/maillog | grep 'connect from unknown' 
	sudo cat /var/log/maillog | grep 'connect from unknown' | sed s/^.*unknown/asdf/ 
	sudo cat /var/log/maillog | grep 'connect from unknown' | sed s/^.*unknown/asdf/ | cut -d "[" -f2 
	sudo cat /var/log/maillog | grep 'connect from unknown' | sed s/^.*unknown/asdf/ | cut -d "[" -f2 | cut -d "]" -f1

##### Write the IP addresses to a file
	sudo cat /var/log/maillog | grep 'connect from unknown' | sed s/^.*unknown/asdf/ | cut -d "[" -f2 | cut -d "]" -f1 > unknown.txt

##### Sort the file and get the unique values
	sort -u unknown.txt
	sort -u unknown.txt > unique.txt

##### See if iptables is running
	sudo service iptables status
	
##### List all the rules in all the chains (-L). Avoid long reverse DNS lookups (-n). Verbose output (-v).
	sudo iptables -vnL
```c
// Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
// pkts bytes target     prot opt in     out     source               destination
// 
// Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
//  pkts bytes target     prot opt in     out     source               destination
// 
// Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
//  pkts bytes target     prot opt in     out     source               destination
```
##### Read the iptables file in sysconfig
	sudo cat /etc/sysconfig/iptables
```c
/*
# Generated by iptables-save v1.4.18 on Tue Mar  8 10:59:11 2016
*filter
:INPUT ACCEPT [113:6108]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [105:6804]
COMMIT
# Completed on Tue Mar  8 10:59:11 2016
*/
```
##### See if iptables is set to start in runlevel 3
	sudo chkconfig

##### Read the iptables-config file in sysconfig
	sudo cat /etc/sysconfig/iptables-config
```bash
# Load additional iptables modules (nat helpers)
#   Default: -none-
# Space separated list of nat helpers (e.g. 'ip_nat_ftp ip_nat_irc'), which
# are loaded after the firewall rules are applied. Options for the helpers are
# stored in /etc/modprobe.conf.
IPTABLES_MODULES=""

# Unload modules on restart and stop
#   Value: yes|no,  default: yes
# This option has to be 'yes' to get to a sane state for a firewall
# restart or stop. Only set to 'no' if there are problems unloading netfilter
# modules.
IPTABLES_MODULES_UNLOAD="yes"

# Save current firewall rules on stop.
#   Value: yes|no,  default: no
# Saves all firewall rules to /etc/sysconfig/iptables if firewall gets stopped
# (e.g. on system shutdown).
IPTABLES_SAVE_ON_STOP="no"

# Save current firewall rules on restart.
#   Value: yes|no,  default: no
# Saves all firewall rules to /etc/sysconfig/iptables if firewall gets
# restarted.
IPTABLES_SAVE_ON_RESTART="no"

# Save (and restore) rule and chain counter.
#   Value: yes|no,  default: no
# Save counters for rules and chains to /etc/sysconfig/iptables if
# 'service iptables save' is called or on stop or restart if SAVE_ON_STOP or
# SAVE_ON_RESTART is enabled.
IPTABLES_SAVE_COUNTER="no"

# Numeric status output
#   Value: yes|no,  default: yes
# Print IP addresses and port numbers in numeric format in the status output.
IPTABLES_STATUS_NUMERIC="yes"

# Verbose status output
#   Value: yes|no,  default: yes
# Print info about the number of packets and bytes plus the "input-" and
# "outputdevice" in the status output.
IPTABLES_STATUS_VERBOSE="no"

# Status output with numbered lines
#   Value: yes|no,  default: yes
# Print a counter/number for every rule in the status output.
IPTABLES_STATUS_LINENUMBERS="yes"
```
##### Edit iptables-config and set IPTABLES_SAVE_ON_STOP to yes
	sudo vim /etc/sysconfig/iptables-config
```bash
# Save current firewall rules on stop.
#   Value: yes|no,  default: no
# Saves all firewall rules to /etc/sysconfig/iptables if firewall gets stopped
# (e.g. on system shutdown).
IPTABLES_SAVE_ON_STOP="yes"
```

##### Stop iptables. Note that the firewall rules are being saved.
	sudo service iptables stop
```c
/*
iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]
iptables: Flushing firewall rules:                         [  OK  ]
iptables: Setting chains to policy ACCEPT: filter          [  OK  ]
iptables: Unloading modules:                               [  OK  ]
*/
```

##### Read the firewall rules
	sudo cat /etc/sysconfig/iptables

##### Start iptables
	sudo service iptables start
	
##### Add a rule to drop traffic from a malcious IP address
	sudo /sbin/iptables -I INPUT -j DROP -s [ --- malicious ip ---]

##### Confirm that the rule was added
	sudo iptables -vnL

##### Save the rule
	sudo /etc/init.d/iptables save

##### Confirm that the rule was added to the iptables file in sysconfig
	sudo cat /etc/sysconfig/iptables

##### Stop iptables	
	sudo /etc/init.d/iptables stop

##### Check the firewall rules. Should be empty.
	sudo iptables -vnL
```c
/*
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

*/
```
##### Start iptables
	sudo /etc/init.d/iptables start

##### Check the firewall rules. The previously saved rules should be displayed. 
	sudo iptables -vnL

##### Make a firewall folder in your home directory
	cd ~
	mkdir firewall
	cd firewall

##### Make a bash script to read through a text file and add DROP rules for every uncommented IP address
	vim apply.rules.sh
```bash
#!/bin/bash
# Reference: http://140.120.7.21/LinuxRef/Network/BlockIP.html

# Ask for the name of the list
read -p "Enter the file name: " file_name

if [ -f $file_name ]; then

   # Get the list
   BLOCKDB=./$file_name

   # Grep the contents of the file, ignore comment lines
   IPS=$(grep -Ev "^#" $BLOCKDB)

   # Loop through every ip address
   for i in $IPS
   do
      # Add drop rules for input and output to and from every ip
      iptables -A INPUT -s $i -j DROP
      iptables -A OUTPUT -d $i -j DROP
   done
fi
```
##### Make the script executable
	chmod u+x apply.rules.sh

##### Run the script in debug mode. Enter the unknown.txt file name.
```
sudo bash -x ./apply.rules.sh
```
```
Enter the file name: unknown.txt
```
##### Confirm that the IP addresses have been blocked
	sudo iptables -vnL

##### Refer to publicly available block lists for additional IP addresses. 
	http://www.wizcrafts.net/iptables-blocklists.html
	
##### Get a copy of one of the wizcrafts files
	wget http://www.wizcrafts.net/chinese-iptables-blocklist.txt

##### Run the script in debug mode against the wizcrafts file
	sudo bash -x ./apply.rules.sh
	
<!---
ad ae af ag ai al am ao ap ar as at au aw az ba bb bd be bf bg bh bi bj bl bm bn bo bq br bs bt bw by bz ca cd cf cg ch ci ck cl cm cn co cr cu cv cw cy cz de dj dk dm do dz ec ee eg er es et eu fi fj fm fo fr ga gb gd ge gf gg gh gi gl gm gn gp gq gr gt gu gw gy hk hn hr ht hu id ie il im in io iq ir is it je jm jo jp ke kg kh ki km kn kp kr kw ky kz la lb lc li lk lr ls lt lu lv ly ma mc md me mf mg mh mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nc ne nf ng ni nl no np nr nu nz om pa pe pf pg ph pk pl pm pr ps pt pw py qa re ro rs ru rw sa sb sc sd se sg si sk sl sm sn so sr ss st sv sx sy sz tc td tg th tj tk tl tm tn to tr tt tv tw tz ua ug us uy uz va vc ve vg vi vn vu wf ws ye yt za zm zw
-->
